# If .trivyignore is changed, add (new) CVE suppression changes to InfluxDB

name: Check for CVE suppression changes

on:
  workflow_call:

jobs:
  check-for-cve-suppressions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Checkout JS Tools
        uses: actions/checkout@v4
        with:
          repository: felleslosninger/eid-github-workflows
          path: tools
      - name: Install InfluxDB Client
        run: |
          npm install @influxdata/influxdb-client
      - name: Check for CVE suppression changes in trivyignore
        id: new-cve-suppressions
        if: ${{ hashFiles('./.trivyignore') != '' }}
        run: |
          # File with CVEs
          TRIVYIGNORE_FILE=.trivyignore

          # File with git diff results
          GIT_DIFF_RAW_FILE=trivy-git-diff.txt

          # CVE format pattern: CVE-[0-9]{4}-[0-9]{1,}
          # With expected leading prefix: '+' for added and '-' for removed
          regex_pattern="^([+]|[-])(CVE|cve)-[0-9]{4}-[0-9]{1,}$"

          git diff --ignore-all-space "${{ env.COMMIT_HASH_BEFORE }}".."${{ env.COMMIT_HASH_AFTER }}" -- $TRIVYIGNORE_FILE > $GIT_DIFF_RAW_FILE

          suppressions_with_delimiter=""
          while read -r diff_string
          do
            suppression=$(cut -d' ' -f 1 <<< "$diff_string")
            if [[ $suppression =~ $regex_pattern ]]; then
              suppressions_with_delimiter+="$suppression,"
            fi
          done < <(grep '' $GIT_DIFF_RAW_FILE)
          echo "suppressions=$suppressions_with_delimiter" >> "$GITHUB_OUTPUT"
        env:
          COMMIT_HASH_BEFORE: ${{ github.event.before }}
          COMMIT_HASH_AFTER: ${{ github.event.after }}
      - name: Write CVE suppressions to InfluxDB
        if: ${{ steps.new-cve-suppressions.outputs.suppressions != '' }}
        id: write-supressions-to-influxdb
        uses: actions/github-script@v6
        env:
          INFLUXDB_TOKEN: ${{ secrets.INFLUXDB_TOKEN_CVE }}
          INFLUXDB_URL: "https://westeurope-1.azure.cloud2.influxdata.com"
          SUPPRESSIONS: ${{ steps.new-cve-suppressions.outputs.suppressions }}
          BUCKET: "cve"
        with:
          script: |
            const Utils = require('./tools/.github/js/utils.js')
            const { InfluxDB, Point } = require("@influxdata/influxdb-client")

            const {
              INFLUXDB_TOKEN,
              INFLUXDB_URL,
              BUCKET,
            } = process.env

            const client = new InfluxDB({
              url: INFLUXDB_URL,
              token: INFLUXDB_TOKEN,
            }).getWriteApi('', BUCKET, "ns")

            const suppressions = [...Utils.toArrayFromString('${{ env.SUPPRESSIONS }}', ',')]

            for (suppression of suppressions) {
              const suppressionWithoutPrefix = `${suppression.substring(1)}`
              const event_type = Utils.getSuppressedOrUnSuppressedEventType(suppression)
              const point = new Point("cve")
                .tag("repository", "${{ github.repository }}")
                .tag("application", "${{ github.event.repository.name }}")
                .stringField("commit_hash", "${{ github.event.head_commit.id }}")
                .stringField("cve", `${suppressionWithoutPrefix}`)
                .stringField("event", `${event_type}`)

              console.log(`Data: ${JSON.stringify(point)}`)
              client.writePoint(point)
            }
